{% extends 'base.html' %}
{% load verbatim %}
{% block media %}

{% verbatim %}
<script id="featured-request-templ" type="text/x-handlebars-template">

	<div class="row">
	  <div class="span4 lesson-title featured-request-span">
		<a class="green reqtitle"><h3 class="no-margin">{{title}}</h3></a>
	  </div>

	  <div class="span2">
		<h4 class="featured-request-text pull-right">${{inpot}} in pot</h4>
	  </div>
    </div>

	<div class="row">
	  <div class="span4 funding-progress featured-request-span">

	  </div>

	  <div class="span2">
		<strong class="ask-pot no-margin pull-right">{{need_by}} left</strong>
	  </div>
    </div>

    <hr class="request-hr" />

    <div class="row">
	  <div class="span6 featured-request-span">
		<div class="request-details-chef"><strong>by <a href="#" class="green">{{chef.user_name}}</strong></a></div>
		<a href="#" class="btn btn-blue btn-request-contribute">answer</a>

		<div class="request-contribute pull-right">
		<span class="">Contribute</strong>
		<div class="request-contribute-input input-prepend">
		  <span class="add-on">$</span>
          <input class="span1 no-margin request-contribute-price" name="price" type="number" min="1" value="1" max="1000" placeholder="Price">
		</div>

		<a href="#" class="btn btn-green btn-request-contribute">contribute</a>
		</div>
	  </div>
    </div>

    <hr class="request-hr" />

    <div class="row">
	  <div class="span3 featured-request-span">
	    <strong class="">serving {{serving_size}}</strong>
	  </div>

	  <div class="span3">
		<strong class="featured-request-text pull-right">taking {{time_in_min}} minutes</strong>
	  </div>
    </div>

    <hr class="request-hr" />

	<div class="row">
	  <div class="span6 featured-request-span">
      {{description}}
      </div>
    </div>

    <hr class="request-hr" />

	<div class="row">
	  <div class="span6 featured-request-span">
        {{#each primary_ingredients}}
		<a class="btn btn-clearblue btn-tags">{{this}}</a>
        {{/each}}
        {{#each restrictions}}
		<a class="btn btn-clearblue btn-tags">{{this}}</a>
        {{/each}}
        {{#each course}}
		<a class="btn btn-clearblue btn-tags">{{this}}</a>
        {{/each}}
        {{#each cuisine}}
		<a class="btn btn-clearblue btn-tags">{{this}}</a>
        {{/each}}
	  </div>
    </div>
</script>
{% endverbatim %}

<script type="text/javascript">
require(['./common',], function(){
    require(['cs!main', 'cs!colorboxcommon', 'liveValidation', 'handlebars'], function(main, cc){
        source = $("#featured-request-templ").html();
        template = Handlebars.compile(source);

        function switchDisplay(slug){
            data = lesson_data[slug]
            dest = $("#featuredrequest")
            dest.html(template(data))
            url = "?slug=" + slug
            window.history.replaceState({}, document.title, url)
        }


        $('.lessonrequest').click(function(){
            t = $(this)
            slug = t.data('slug')
            switchDisplay(slug)
        })

        $("#requestform-btn").click(function(){
           cc.setupColorbox("#requestform")
        })

        switchDisplay("{{slug}}")

    })
})
lesson_data = {{lesson_json|safe}}
$()
</script>
{% endblock %}

{% block content %}

<div class="bordered-row bordered">
  <div class="span12">
	<div class="row">
      <div class="span6 request-message">
        Click on a request for more details
      </div>

      <div class="span6 request-links">
        Still looking?
        {% if request.user.is_authenticated %}
        <a href="#" id="requestform-btn" class="btn btn-green">create a request</a>
        {% endif %}
        <a href="{% url lessons %}" class="btn btn-blue"> view lessons</a>
      </div>
    </div>
  </div>
</div>


<div class="bordered-row bordered">

  <div id="featuredrequest" class="span6">
    <div class="row">
	  <div class="span6">
        <img src="{{STATIC_URL}}img/loading.gif"/>
      </div>
    </div>
  </div>
  <div id="requests-list" class="span6">
   {% for req in lesson_requests %}
   <span class="lessonrequest" data-slug="{{req.slug}}">
   <div class="row">
	{% if forloop.first %}
	<div class="span6 request request-first">
	{% elif forloop.last %}
	<div class="span6 request request-last">
	{% else %}
	<div class="span6 request">
	{% endif %}
 	  <div class="row">
		  <div class="span4 lesson-title request-title">
			<a class="green reqtitle"><h3 class="no-margin">{{req.title}}</h3></a>
		  </div>

		  <div class="span2">
			<h4 class="ask-pot no-margin pull-right">${{req.in_pot|default:"0"|floatformat}} in pot</h4>
		  </div>
      </div>

	  <div class="row">
		<div class="span4">
		  <div class="lesson-tile-description">
		    <small>{{req.description}}</small>
		  </div>
        </div>

        <div class="span2">
		  <div class="timetoraise pull-right"><strong>{{req.need_by|timeuntil}} left</strong></div>

          <div class="attatchedchef pull-right"><strong>by
          {% if req.chef_attatched %}
          <a href="{% url miniprofile req.chef_attatched.id %}" class="miniprofile-btn green">{{req.chef_attatched}}</strong></a></div>
          {% else %}
          <a href="#" class="green">No Chef yet!</strong></a></div>
          {% endif %}
		</div>
      </div>

    </div>
   </div>
   </span>
   {% if forloop.last %}
   {% else %}
	<div class="span6 request-margin"></div>
   {% endif %}
   {% endfor %}
  </div>
</div>

{% include "pager.html" with pager=lesson_requests %}

<div class="row no-display">
  {% include "lesson_request.html" with request_form=form %}
</div>
{% endblock %}
