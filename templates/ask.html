{% extends 'base.html' %}
{% load verbatim %}
{% block media %}

{% verbatim %}
<script id="featured-request-templ" type="text/x-handlebars-template">

	<div class="row">
	  <div class="span4 lesson-title featured-request-span">
		<a class="primary reqtitle"><h3 class="no-margin">{{title}}</h3></a>
	  </div>

	  <div class="span2">
		<h4 class="featured-request-text pull-right">${{inpot}} in pot</h4>
	  </div>
    </div>

	<div class="row">
	  <div class="span4 funding-progress featured-request-span">

	  </div>

	  <div class="span2">
		<strong class="ask-pot no-margin pull-right">{{need_by}} left</strong>
	  </div>
    </div>

    <hr class="request-hr" />

    <div class="row">
	  <div class="span6 featured-request-span">
        <a href="" >{{req.chef_attatched}}</strong></a>
        {{# if chef }}
		   <div class="request-details-chef"><strong>by <a href="{{chef_profile_url}}" class="miniprofile-btn primary">{{chef.full_name}}</strong></a></div>
        {{ else }}
           <div class="request-details-chef"><strong>by <a href="#" class="primary">No Chef Yet!</strong></a></div>
        {{/ if }}
		<a href="#" class="btn btn-secondary btn-request-contribute">answer</a>
          {% endverbatim %}
          <form class="contribute-form" action="{% url contribute  %}" method="post">
          {% csrf_token %}
          {% include "contribute_form.html" with contribute_form=contribute_form %}
          <input type="hidden" name='{{contribute_form.request_slug.name}}'  {% verbatim %} value="{{slug}}">
          </form>
	  </div>
    </div>

    <hr class="request-hr" />

    <div class="row">
	  <div class="span3 featured-request-span">
	    <strong class="">serving {{serving_size}}</strong>
	  </div>

	  <div class="span3">
		<strong class="featured-request-text pull-right">taking {{time_in_min}} minutes</strong>
	  </div>
    </div>

    <hr class="request-hr" />

	<div class="row">
	  <div class="span6 featured-request-span">
      {{description}}
      </div>
    </div>

    <div class="progress request-progress">
      <div class="bar request-bar" style="width: {{percent}}%;"></div>
    </div>


    <hr class="request-hr" />

	<div class="row">
	  <div class="span6 featured-request-span">
        {{#each primary_ingredients}}
		<a class="btn btn-clearsecondary btn-tags">{{this}}</a>
        {{/each}}
        {{#each restrictions}}
		<a class="btn btn-clearsecondary btn-tags">{{this}}</a>
        {{/each}}
        {{#each course}}
		<a class="btn btn-clearsecondary btn-tags">{{this}}</a>
        {{/each}}
        {{#each cuisine}}
		<a class="btn btn-clearsecondary btn-tags">{{this}}</a>
        {{/each}}
	  </div>
    </div>
    <div class="row">
      <div class="span2">
        <div addthis:url="http://culination.com/ask?slug={{slug}}" class="addthis_toolbox addthis_default_style addthis_32x32_style">
          <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
          <a class="addthis_button_pinterest_pinit"></a>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="span6">
        {{pledges.length}} contributors date amount pledged
        {{#each pledges}}
        {{user_name}} {{date_pledged}} ${{amount}}
        {{/each}}
      </div>
    </div>
</script>
{% endverbatim %}

<script type="text/javascript">
has_stripe = {% if request.user.customer %}true{%else%}false{%endif%}
function stripeResponseHandler(status, response){
    if (status == 200){
        has_stripe = true
        stripe_input = $("<input type='hidden' name='stripe-id'>")
        stripe_input.attr('value', response.id)

        $('.contribute-form').append(stripe_input)
        $('.contribute-form').submit()
    }

}
require(['./common',], function(){
    require(['cs!main', 'cs!colorboxcommon', 'liveValidation', 'handlebars'], function(main, cc){
        source = $("#featured-request-templ").html();
        template = Handlebars.compile(source);
        $(".btn-createlesson").click(function(e){
            cc.setupColorbox($(this).parent().find('.chef-pledge'))
        })
        function switchDisplay(slug){
            data = lesson_data[slug]
            dest = $("#featuredrequest")
            dest.html(template(data))
            url = "?slug=" + slug
            window.history.replaceState({}, document.title, url)
            addthis.toolbox(".addthis_toolbox")
            $('.contribute-form').submit(function(e){
                if (has_stripe){
                    return true
                }
                else {
                    cc.setupColorbox('#payment')
                    return false
                }
            })
        }


        $('.lessonrequest').click(function(){
            t = $(this)
            slug = t.data('slug')
            switchDisplay(slug)
        })

        $("#requestform-btn").click(function(){
           cc.setupColorbox("#requestform")
        })

        switchDisplay("{{slug}}")

    })
})
lesson_data = {{lesson_json|safe}}
$()
</script>
{% endblock %}

{% block content %}

<div class="bordered-row bordered">
  <div class="span12">
	<div class="row">
      <div class="span6 request-message">
        Click on a request for more details
      </div>

      <div class="span6 request-links">
        Still looking?
        {% if request.user.is_authenticated %}
        <a href="#" id="requestform-btn" class="btn btn-primary">create a request</a>
        {% endif %}
        <a href="{% url lessons %}" class="btn btn-secondary"> view lessons</a>
      </div>
    </div>
  </div>
</div>


<div class="bordered-row bordered">

  <div id="featuredrequest" class="span6">
    <div class="row">
	  <div class="span6">
        <img src="{{STATIC_URL}}img/loading.gif"/>
      </div>
    </div>
  </div>
  <div id="requests-list" class="span6">
   {% for req in lesson_requests %}
   <span class="lessonrequest" data-slug="{{req.slug}}">
   <div class="row">
	{% if forloop.first %}
	<div class="span6 request request-first">
	{% elif forloop.last %}
	<div class="span6 request request-last">
	{% else %}
	<div class="span6 request">
	{% endif %}
 	  <div class="row">
		  <div class="span4 lesson-title request-title">
			<a class="primary reqtitle"><h3 class="no-margin">{{req.title}}</h3></a>
		  </div>

		  <div class="span2">
			<h4 class="ask-pot no-margin pull-right">${{req.in_pot|default:"0"|floatformat}} in pot</h4>
		  </div>
      </div>

	  <div class="row">
		<div class="span4">
		  <div class="lesson-tile-description">
		    <small>{{req.description}}</small>
		  </div>
        </div>

        <div class="span2">
		  <div class="timetoraise pull-right"><strong>{{req.need_by|timeuntil}} left</strong></div>

          <div class="attatchedchef pull-right"><strong>
          {% if req.chef_attatched %}
          by <a href="{% url miniprofile req.chef_attatched.id %}" class="miniprofile-btn primary">{{req.chef_attatched.full_name}}</strong></a>
          {% elif user.get_profile.professional_chef %}
            <div class="btn btn-primary btn-createlesson">Create lesson</div>
            <div class="row no-display">
              {% include "chef_pledge.html" with pledge_form=pledge_form slug=req.slug%}
            </div>
          {% else %}
          <a href="#" class="primary">No Chef yet!</strong></a>
          {% endif %}
          </div>
		</div>
      </div>

    </div>
   </div>
   </span>
   {% if forloop.last %}
   {% else %}
	<div class="span6 request-margin"></div>
   {% endif %}
   {% endfor %}
  </div>
</div>

{% include "pager.html" with pager=lesson_requests %}

<div class="row no-display">
  {% include "lesson_request.html" with request_form=request_form %}
</div>

<div class="row no-display">
  {% include "payment.html" %}
</div>

{% endblock %}
